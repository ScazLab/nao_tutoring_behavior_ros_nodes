# nao_tutoring_behavior_ros_nodes

This repository contains code for the ROS nodes controlling the tutoring behavior study. 
It is set up to run in Docker so that it may be run on any operating system, though the ROS code could be pulled out of the Docker container if being run on a Linux machiene.

# Running in Docker

To run the docker container, run the command:
docker run -it -p 9090:9090 -v  /*path_to*/nao_tutoring_behavior_ros/catkin_ws:/root/catkin_ws nao_tutoring_behavior

-p 9090:9090 specifies that port 9090 on your local machiene is mapped to port 9090 in the container. This is important to note for running the tablet server later.

In a second terminal, run:
docker ps -l

This will show you a list of docker containers open. Find the name of the open container in the last column. 
Then run:
docker exec -it *name_of_container* bash

Open two more docker terminals. Before running the ros nodes, you must first run:
source ./devel/setup.bash

In your four docker terminals, run the following commands (one per terminal):
roscore
rosrun nao_tutoring_behaviors node_model_dummy.py 
rosrun nao_tutoring_behaviors node_tablet.py 
rosrun nao_tutoring_behaviors node_robot_controller.py [--robot]            (the --robot flag indicates that the node should connect to Nao)

The ROS nodes are now running. In the terminal running node_tablet.py, you should see that it is waiting for the tablet to connect.

# ROS Messages
The nodes communicate via the following message streams:

robot_speech_msg : the robot publishes here to indicate when it begins and finishes speaking. This allows the tablet to disable buttons during this time.

robot_lesson_msg : the robot publishes here when it speaks to give an example. This lets the tablet react to robot speech during examples and tutorials to show the right steps at the next time. The model node does not subscribe to this.

robot_inactivity_msg : the robot publishes here when it speaks during other activities, like during a tictactoe game. This is separate so that the model is not spammed with too many messages between tablet node and robot during an activity. The model node does not subscribe to this.

These three prior messages are all simple strings.

tablet_msg : the tablet node publishes here to inform the model and the robot of what the tablet is doing and what actions should be taken. It sends a TabletMsg which contains a msgType (string), questionNumOrPart (int), robotSpeech (string) and a string of otherInfo.
Examples of msgTypes are 'CA' indicating a correct answer, 'IA' indicating an incorrect answer, 'TICTATOE-[WIN/LOSS]' indicating the end of a tictactoe game, 'START' to indicate the start of the session, or 'SHOWING-QUESTION' to indicate that the tablet has just displayed a question. Both the robot controller and model subscribe to this.

tablet_lesson_msg : the tablet node publishes here during an example to instruct the robot what to say. This is separate so that the robot can respond with a the robot_lesson_msg to trigger the next step, and so as to avoid sending too many unneeded messages to the model. 

tablet_inactivity_msg: the tablet node publishes here during other activities, like tic tac toe. Only the robot subscribes.

model_decision_msg : the model publishes the next action that should be taken. This is in the form of a ControlMsg, which contains a nextStep (string), questionNum, questionLevel, a string of robotSpeech and string of otherInfo.

Currently the "otherInfo" in both TabletMsgs and ControlMsgs is unused so I will probably remove it in a next commit. 

# Most important files and locations:
There are a lot of directories generated by ROS, so here are the paths of the most relevant and important things:
message types are all in /catkin_ws/src/nao_tutoring_behaviors/msg

The three node files are in:
/catkin_ws/src/nao_tutoring_behaviors/scripts/node_robot_controller.py
/catkin_ws/src/nao_tutoring_behaviors/scripts/node_tablet.py
/catkin_ws/src/nao_tutoring_behaviors/scripts/node_model_dummy.py

Code to generate the steps of division examples (e.g. finding the values that should go in structure boxes) is in:
/catkin_ws/src/nao_tutoring_behaviors/scripts/example_generation.py
